name: zstd build

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      create-pullrequest:
        description: true to craete PR for artifacts.
        required: true
        type: boolean
        default: false
  push:
    branches: [main]
  pull_request:
    branches: [main]

# OUTPUT_DIR name follow to .NET RID rule. https://docs.microsoft.com/ja-jp/dotnet/core/rid-catalog
# win-x64, linux-x64, osx-x64

env:
  CREATE_PR: ${{ github.event.inputs.create-pullrequest == 'true' && github.event.inputs.create-pullrequest || 'false' }}

jobs:
  android:
    strategy:
      fail-fast: false
      matrix:
        target: ["x86", "x64", "arm", "arm64"]
    env:
      OUTPUT_DIR: artifact/zstd/ios-${{ matrix.target }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - run: git fetch --tags
        working-directory: zstd
      - name: Build
        run: bash ./builder/zstd/zstd-android-${{ matrix.target }}.sh
      - name: show generated files
        run: git ls-files --other --modified --exclude-standard
      - uses: actions/upload-artifact@v3
        with:
          name: artifact
          path: artifact
        if: ${{ env.CREATE_PR == 'true' }}

  ios:
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: arm64
            os: macos-latest
    env:
      OUTPUT_DIR: artifact/zstd/ios-${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - run: git fetch --tags
        working-directory: zstd
      - name: Build
        run: bash ./builder/zstd/zstd-ios-arm64.sh
      - name: show generated files
        run: git ls-files --other --modified --exclude-standard
      - uses: actions/upload-artifact@v3
        with:
          name: artifact
          path: artifact
        if: ${{ env.CREATE_PR == 'true' }}

  linux:
    strategy:
      fail-fast: false
      matrix:
        target: ["x64", "arm64"]
    env:
      OUTPUT_DIR: artifact/zstd/linux-${{ matrix.target }}
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - run: git fetch --tags
        working-directory: zstd
      - name: Build
        run: bash ./builder/zstd/zstd-linux-${{ matrix.target }}.sh
      - name: show generated files
        run: git ls-files --other --modified --exclude-standard
      - uses: actions/upload-artifact@v3
        with:
          name: artifact
          path: artifact
        if: ${{ env.CREATE_PR == 'true' }}

  macos:
    strategy:
      fail-fast: false
      matrix:
        target: ["x64", "arm64"]
    env:
      OUTPUT_DIR: artifact/zstd/osx-${{ matrix.target }}
    runs-on: macos-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - run: git fetch --tags
        working-directory: zstd
      # host runner is x86_64 and cannot link x86_64 `lz4` & `lzma` to arm64 build
      - run: brew uninstall --ignore-dependencies lz4 xz
        if: ${{ matrix.target == 'arm64' }}
      - name: Build
        run: bash ./builder/zstd/zstd-darwin-${{ matrix.target }}.sh
      - name: show generated files
        run: git ls-files --other --modified --exclude-standard
      - uses: actions/upload-artifact@v3
        with:
          name: artifact
          path: artifact
        if: ${{ env.CREATE_PR == 'true' }}

  windows:
    strategy:
      fail-fast: false
      matrix:
        target: ["x64", "x86", "arm64"]
    env:
      OUTPUT_DIR: artifact\zstd\win-${{ matrix.target }}
    runs-on: windows-2022
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: true
      - run: git fetch --tags
        working-directory: zstd
      - name: Add MSBuild to PATH
        uses: microsoft/setup-msbuild@v1.1
      - name: Build
        run: builder\zstd\zstd-windows-${{ matrix.target }}-cmake.bat
        shell: cmd
      - name: show generated files
        run: git ls-files --other --modified --exclude-standard
      - uses: actions/upload-artifact@v3
        with:
          name: artifact
          path: artifact
        if: ${{ env.CREATE_PR == 'true' }}

  pr:
    if: ${{ github.event.inputs.create-pullrequest == 'true' }}
    needs: [ios, linux, macos, windows]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: artifact
          path: _tmp
      - name: Copy to artifact
        run: mkdir -p ./artifact/ && cp -fR ./_tmp/* ./artifact/
      - name: Check for modified files
        id: git-check
        run: echo "::set-output name=modified::$(if [[ "$(git status --porcelain=v1 2>/dev/null | wc -l)" == "0" ]]; then echo "false"; else echo "true"; fi)"
      - if: steps.git-check.outputs.modified == 'true'
        name: Create PullRequest
        uses: peter-evans/create-pull-request@v4
        with:
          base: "main"
          branch: "auto/zstd_artifact"
          author: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
          delete-branch: true
          title: "[zstd] Update artifacts"
          labels: |
            automated pr
